name: Deploy .NET Backend to Azure App Service

on:
  push:
    branches: [master]
    paths:
      - 'server-dotnet/**'
      - 'public/**'
      - '.github/workflows/deploy-dotnet.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Chatbot-RAG

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      - name: Publish .NET app
        run: |
          dotnet publish server-dotnet/ChatbotRag.Api/ChatbotRag.Api.csproj \
            -c Release \
            -o ./publish

      - name: Copy frontend assets
        run: |
          mkdir -p publish/wwwroot
          cp -r public/. publish/wwwroot/

      - name: Create Oryx manifest (helps App Service startup script generator)
        run: |
          cat > publish/oryx-manifest.toml << 'EOF'
          PlatformName = "dotnet"
          PlatformVersion = "10.0"
          OperationID = "dotnet-chatbotrag"
          EOF

      - name: Create deployment package
        run: |
          cd publish
          # Use python to zip with forward slashes (avoids backslash issues)
          python3 -c "
          import zipfile, os
          with zipfile.ZipFile('../deploy-dotnet.zip', 'w', zipfile.ZIP_DEFLATED) as zf:
              for root, dirs, files in os.walk('.'):
                  # Skip unnecessary dirs
                  dirs[:] = [d for d in dirs if d not in ['.git', '__pycache__']]
                  for file in files:
                      filepath = os.path.join(root, file)
                      arcname = os.path.relpath(filepath, '.').replace(os.sep, '/')
                      zf.write(filepath, arcname)
          print('ZIP created')
          "
          cd ..
          echo "Package size: $(du -h deploy-dotnet.zip | cut -f1)"

      - name: Deploy to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: func-consultas-internas
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: deploy-dotnet.zip
